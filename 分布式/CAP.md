# CAP

在一个分布式系统中（指互相连接并共享数据的节点集合）中，当涉及到读写操作时，只能保证一致性（Consistency）、可用性(Availability）、分区容错性（Partition Tolerance）三者中的两个，另外一个必须被牺牲。

<img src="https://raw.githubusercontent.com/xuhaoyao/images/master/img/image-20220309214112611.png" alt="image-20220309214112611" style="zoom: 67%;" />

**一致性（Consistency）:**

一致性说的是多个节点的数据副本是否保持一致的特性。对系统的一个数据更新成功之后，如果所有用户都能够读取最新的值，该系统就被认为有强一致性。

**可用性（Availability）:**

在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求，要求系统提供的服务一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。**要保证99.99%可用。**

**分区容错性（Partition Tolerance）:**

在分区容错性条件下，分布式系统在遇到任何网络分区故障的时候，仍然需要能对外提供一致性和可用性的服务，除非是整个网络环境都发生了故障。

> 网络分区：分布式系统中，多个节点之前的网络本来是连通的，但是因为某些故障（比如部分节点网络出现了问题），某些节点之间不连通了，整个网络就被分成了几个区域，每个区域内部可以通信，但区域间无法通信。



## 分布式系统理论上不可能选择CA

在分布式的环境下，网络无法做到100%可靠，肯定会有某些节点在某些时候出现故障，因此分区是一个必然的选择。

如果选择了CA而放弃了P，若发生了网络分区，此时系统中的某个节点正在进行写操作：

- 为了保证C，系统需要禁止写入，此时就与A发生了冲突。
- 为了保证A，其他的节点读写正常的话，这就与C冲突了。

**因此分布式系统理论上不可能选择CA,只能选择AP或者CP架构。**

可用性和一致性往往是冲突的，很难使它们同时满足。在多个节点之间进行数据同步时，

- 为了保证一致性（CP），不能访问未同步完成的节点，也就失去了部分可用性；
- 为了保证可用性（AP），允许读取所有节点的数据，但是数据可能不一致。



## BASE

BASE 是基本可用（Basically Available）、软状态（Soft State）和最终一致性（Eventually Consistent）三个短语的缩写。

BASE 理论是对 CAP 中一致性和可用性权衡的结果，它的核心思想是：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。

**BASE理论是CAP中AP方案的延申**

**基本可用：**

指分布式系统在出现故障的时候，保证核心可用，允许损失部分可用性。

例如，电商在做促销时，为了保证购物系统的稳定性，部分消费者可能会被引导到一个降级的页面。

> 损失部分可用性：
>
> - 响应时间上的损失：正常情况下，处理用户请求需要0.5s返回结果，由于系统出现故障，处理请求的时间变为3s
> - 系统功能上的损失：正常情况下，用户可以使用系统的全部功能，但是由于系统访问量突然剧增，系统的**部分非核心功能**无法使用。

**软状态：**

指允许系统中的数据存在中间状态，并认为该中间状态不会影响系统整体可用性，即允许系统不同节点的数据副本之间进行同步的过程存在时延。

> 就比如说我订单，被用户取消了，这时候库存还是锁定的状态，而实际上这一部分库存现在是可以使用的，这就是中间状态。

**最终一致性：**

最终一致性强调的是系统中所有的数据副本，**在经过一段时间的同步后，最终能达到一致的状态。**

ACID 要求强一致性，通常运用在传统的数据库系统上。而 BASE 要求最终一致性，通过牺牲强一致性来达到可用性，通常运用在大型分布式系统中。

在实际的分布式场景中，不同业务单元和组件对一致性的要求是不同的，因此 ACID 和 BASE 往往会结合在一起使用。

> 分布式一致性的 3 种级别：
>
> 1. **强一致性** ：系统写入了什么，读出来的就是什么。
> 2. **弱一致性** ：不一定可以读取到最新写入的值，也不保证多少时间之后读取到的数据是最新的，只是会尽量保证某个时刻达到数据一致的状态。
> 3. **最终一致性** ：弱一致性的升级版，系统会保证在一定时间内达到数据一致的状态。
>
> **业界比较推崇是最终一致性级别，但是某些对数据一致要求十分严格的场景比如银行转账还是要保证强一致性。**

实现最终一致性的一些例子：

- Redis主从复制，采用的就是AP的方案，它允许主机和从机之间存在短暂的数据不一致，从机每秒会发送ACK给主机，告诉自己目前的复制偏移量，主机就能知道双方数据是否存在不一致了，若不一致的话，看具体情况就可以采取完全重同步或者部分重同步。
  - 这是一种**异步复制**的方式，通过定时对账检测副本数据的一致性，并修复。
- 项目中的库存数量和已锁定库存数量，用户下订单的时候锁定库存，在这之后用户可能将这个订单取消了，但这时候库存数量还是已经锁定的状态，这一阶段就是**软状态**，而我们发往MQ的消息是有过期的时间的，保证了在一段时间的同步后，这个库存能被解锁，实现最终一致性。

> 刚性事务：遵循ACID原则，强一致性。
>
> 柔性事务：遵循BASE理论，最终一致性。
>
> 柔性事务允许一定时间内不同节点的数据不一致，但要求一定时间后最终一致。